<?php

namespace App\Http\Controllers\API;

use App\Enums\AddressType;
use App\Http\Controllers\Controller;
use App\Models\{Customer, Product, Order};
use App\Enums\CustomerStatus;
use App\Enums\OrderStatus;
use Illuminate\Http\JsonResponse;

class DashboardController extends Controller
{
	public function activeCustomers() : JsonResponse
	{
		$activeCustomers = Customer::where('status', CustomerStatus::Active->value)->count();
		return response()->json(['active_customers' => $activeCustomers]);
	}
	
	public function activeProducts() : JsonResponse
	{
		// TODO: Implement the logic to count active products
		$activeProducts = Product::count('id');
		
		return response()->json(['active_products' => $activeProducts]);
	}
	
	public function paidOrders() : JsonResponse
	{
		$paidOrders = Order::where('status', OrderStatus::Paid->value)->count();
		
		return response()->json(['paid_orders' => $paidOrders]);
	}
	
	public function totalSale() : JsonResponse
	{
		$totalSale = Order::where('status', OrderStatus::Paid->value)->sum('total_price');
		
		return response()->json(['total_sale' => $totalSale]);
	}
	
	public function ordersByCountry() : JsonResponse
	{
		$orders = Order::query()
			->join('users', 'created_by', '=', 'users.id')
			->join('customer_addresses AS ca', 'ca.customer_id', '=', 'users.id')
			->join('countries AS c', 'ca.country_code', '=', 'c.code')
			->selectRaw('c.name AS country, count(orders.id) AS count')
			->groupBy('country')
			->whereIn('status', [OrderStatus::Paid->value, OrderStatus::Shipped->value, OrderStatus::Completed->value])
			->where('a.type', AddressType::Shipping->value)
			->get();
		
		return response()->json(['orders_by_country' => $orders]);
	}
}